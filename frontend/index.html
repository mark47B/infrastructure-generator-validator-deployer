<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Infrastructure Generator Frontend</title>
<style>
:root {
--primary-color: #1e3a8a;
--secondary-color: #3b82f6;
--success-color: #22c55e;
--danger-color: #ef4444;
--bg-color: #f8fafc;
--text-color: #1e293b;
--border-radius: 8px;
--shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}
body {
font-family: 'Inter', sans-serif;
background: var(--bg-color);
color: var(--text-color);
padding: 2rem;
max-width: 1200px;
margin: 0 auto;
}
h1, h2 {
color: var(--primary-color);
margin-bottom: 1rem;
}
#generate-form {
background: white;
padding: 1.5rem;
border-radius: var(--border-radius);
box-shadow: var(--shadow);
margin-bottom: 2rem;
}
#description, #target {
width: 100%;
padding: 0.75rem;
border: 1px solid #d1d5db;
border-radius: var(--border-radius);
font-family: inherit;
margin-bottom: 1rem;
}
#description {
height: 100px;
resize: vertical;
}
#target {
height: 40px;
}
#generate-btn {
background: var(--secondary-color);
color: white;
padding: 0.75rem 1.5rem;
border: none;
border-radius: var(--border-radius);
cursor: pointer;
font-weight: 600;
transition: background-color 0.2s;
}
#generate-btn:hover:not(:disabled) {
background: #2563eb;
}
#generate-btn:disabled {
background: #9ca3af;
cursor: not-allowed;
}
#jobs-table {
width: 100%;
border-collapse: collapse;
background: white;
box-shadow: var(--shadow);
border-radius: var(--border-radius);
}
#jobs-table th, #jobs-table td {
padding: 0.75rem;
border-bottom: 1px solid #e5e7eb;
}
#jobs-table th {
background: var(--primary-color);
color: white;
}
.deploy-btn, .deploy-job-btn {
  padding: 0.5rem 1rem;
  border-radius: var(--border-radius);
  color: white;
  border: none;
  cursor: pointer;
  font-weight: 600;
  margin-right: 0.5rem;
  background: var(--success-color);
}
.deploy-btn { background: var(--success-color); }

.reject-btn, .reject-job-btn {
  padding: 0.5rem 1rem;
  border-radius: var(--border-radius);
  color: white;
  border: none;
  cursor: pointer;
  font-weight: 600;
  margin-right: 0.5rem;
  background: var(--danger-color);
}
/* hover */
.deploy-btn:hover:not(:disabled), .deploy-job-btn:hover:not(:disabled) {
  background: #16a34a;
}
.reject-btn:hover:not(:disabled), .reject-job-btn:hover:not(:disabled) {
  background: #dc2626;
}
.deploy-btn:disabled, .deploy-job-btn:disabled,
.reject-btn:disabled, .reject-job-btn:disabled {
  background: #9ca3af;
  cursor: not-allowed;
}
#chat-modal {
display: none;
position: fixed;
top: 0; left: 0;
width: 100%; height: 100%;
background: rgba(0, 0, 0, 0.6);
justify-content: center;
align-items: center;
}
#chat-content {
background: white;
padding: 1.5rem;
width: 80%;
max-width: 800px;
height: 80vh;
display: flex;
flex-direction: column;
border-radius: var(--border-radius);
box-shadow: var(--shadow);
position: relative;
}
#chat-messages {
flex: 1;
overflow-y: auto;
border: 1px solid #e5e7eb;
border-radius: var(--border-radius);
padding: 1rem;
background: #f9fafb;
margin-bottom: 1rem;
}
.file-message {
background: #eef2ff;
border-left: 4px solid var(--secondary-color);
padding: 0.75rem;
margin-bottom: 0.5rem;
}
#close-chat {
position: absolute;
top: 10px; right: 20px;
cursor: pointer;
font-weight: 700;
color: var(--danger-color);
}
</style>
</head>
<body>
<h1>Infrastructure Generator</h1>
<div id="generate-form">
<h2>Create Job</h2>
<textarea id="description" placeholder="Describe infrastructure..." aria-label="Infrastructure description"></textarea>
<select id="target" aria-label="Select target platform">
<option value="" disabled selected>Select target</option>
<option value="terraform">Terraform</option>
<option value="kubernetes">Kubernetes</option>
<option value="ansible">Ansible</option>
</select>
<button id="generate-btn" aria-label="Create new job">Create Job</button>
</div>
<h2>Jobs</h2>
<table id="jobs-table" aria-label="Jobs table">
<thead>
<tr>
<th scope="col">ID</th>
<th scope="col">Status</th>
<th scope="col">Actions</th>
</tr>
</thead>
<tbody id="jobs-body"></tbody>
</table>
<div id="chat-modal" role="dialog" aria-label="Job files dialog">
  <div id="chat-content">
    <button id="close-chat" aria-label="Close dialog">X</button>
    <h3>Files for Job <span id="chat-job-id"></span></h3>
    <div id="chat-messages" aria-live="polite"></div>

    <div style="margin-top: 1rem; text-align: right;">
      <button id="apply-deploy-btn"
              class="deploy-btn"
              aria-label="Apply deploy for this job">
        Apply Deploy
      </button>
    </div>
  </div>
</div>
<script>
const API_BASE = 'http://localhost:8080/api/v1';
let jobs = [];

function escapeHTML(str) {
    if (typeof str !== 'string') return '';
    return str.replace(/[&<>"']/g, match => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
    })[match]);
}

async function fetchJobs() {
    try {
        const res = await fetch(`${API_BASE}/jobs`, {
            headers: { 'Accept': 'application/json' }
        });
        if (!res.ok) throw new Error(`Failed to fetch jobs: ${res.status}`);
        jobs = await res.json();
        renderJobs();
    } catch (err) {
        console.error('Error in fetchJobs:', err.message);
        alert(`Failed to fetch jobs: ${err.message}`);
    }
}
function renderJobs() {
    try {
        const tbody = document.getElementById('jobs-body');
        tbody.innerHTML = '';
        if (jobs != null) {
            jobs.forEach(job => {
                const tr = document.createElement('tr');
                const actions = [];
                if (job.status?.toLowerCase() === 'ready_to_deploy') {
                    actions.push(
                        `<button class="deploy-job-btn" data-id="${escapeHTML(job.id)}" aria-label="Deploy job ${escapeHTML(job.id)}">Deploy</button>`,
                        `<button class="reject-job-btn" data-id="${escapeHTML(job.id)}" aria-label="Reject job ${escapeHTML(job.id)}">Reject</button>`
                    );
                }
                tr.innerHTML = `
                    <td>${escapeHTML(job.id) || 'N/A'}</td>
                    <td>${escapeHTML(job.status) || 'Unknown'}</td>
                    <td>${actions.join(' ')}</td>
                `;
                tbody.appendChild(tr);
            });

            attachActionListeners();
        }
    } catch (err) {
        console.error('Error in renderJobs:', err.message);
        alert(`Failed to render jobs: ${err.message}`);
    }
}
function attachActionListeners() {
    try {
        document.querySelectorAll('#jobs-table .deploy-job-btn').forEach(btn => {
            btn.onclick = async () => {
                btn.disabled = true;
                await openChat(btn.dataset.id);
                btn.disabled = false;
            };
        });
        document.querySelectorAll('#jobs-table .reject-job-btn').forEach(btn => {
            btn.onclick = async () => {
                btn.disabled = true;
                const id = btn.dataset.id;
                try {
                    const res = await fetch(`${API_BASE}/jobs/${id}`, {
                        method: 'DELETE',
                        headers: { 'Accept': 'application/json' }
                    });
                    if (!res.ok) throw new Error(`Failed to reject job: ${res.status}`);
                    await fetchJobs();
                } catch (err) {
                    console.error('Failed to reject job:', err.message);
                    alert(`Failed to reject job: ${err.message}`);
                } finally {
                    btn.disabled = false;
                }
            };
        });
    } catch (err) {
        console.error('Error in attachActionListeners:', err.message);
        alert(`Failed to attach action listeners: ${err.message}`);
    }
}
async function openChat(jobId) {
    try {
        console.log('Opening chat for jobId:', jobId);
        const chatJobIdEl = document.getElementById('chat-job-id');
        chatJobIdEl.textContent = jobId || ''; // оставляем textContent "чистым"
        const modal = document.getElementById('chat-modal');
        modal.style.display = 'flex';
        modal.dataset.jobId = jobId || '';

        const msgContainer = document.getElementById('chat-messages');
        msgContainer.innerHTML = '<p>Loading files...</p>';
        const res = await fetch(`${API_BASE}/jobs/${jobId}/files`, {
            headers: { 'Accept': 'application/json' }
        });
        if (!res.ok) throw new Error(`Failed to fetch files: ${res.status}`);
        const files = await res.json();
        msgContainer.innerHTML = '';
        if (!Array.isArray(files) || files.length === 0) {
            msgContainer.innerHTML = '<p>No files found for this job.</p>';
            return;
        }

        files.forEach(file => {
            const div = document.createElement('div');
            div.classList.add('file-message');
            div.innerHTML = `<strong>${escapeHTML(file.name) || 'Unknown'}</strong><pre>${escapeHTML(file.content || '')}</pre>`;
            msgContainer.appendChild(div);
        });
        await fetchJobs();
    } catch (err) {
        console.error('Error in openChat:', err.message);
        document.getElementById('chat-messages').innerHTML = `<p style="color:red;">Error loading files: ${escapeHTML(err.message)}</p>`;
    }
}
async function applyDeploy(jobIdFromArg) {
    const btn = document.getElementById('apply-deploy-btn');
    try {
        const modal = document.getElementById('chat-modal');
        const jobId = jobIdFromArg || modal.dataset.jobId || document.getElementById('chat-job-id').textContent;
        if (!jobId) {
            console.error('Cannot deploy: jobId is undefined');
            alert('Cannot deploy: Invalid job ID');
            return;
        }
        btn.disabled = true;
        btn.textContent = 'Deploying...';

        console.log('Sending deploy request to:', `${API_BASE}/jobs/${jobId}/deploy`);
        const startTime = Date.now();
        const res = await fetch(`${API_BASE}/jobs/${jobId}/deploy`, {
            method: 'POST',
            headers: { 
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({})
        });

        const duration = Date.now() - startTime;
        console.log(`Deploy request completed in ${duration}ms, status: ${res.status}`);

        if (!res.ok) {
            const text = await res.text();
            console.error('Deploy response:', res.status, text);
            throw new Error(`Failed to deploy job (${res.status}): ${text}`);
        }

        const responseData = await res.json();
        console.log('Deploy response data:', responseData);

        alert('Deployment started successfully!');
        document.getElementById('chat-modal').style.display = 'none';
        await fetchJobs();
    } catch (err) {
        console.error('Error in applyDeploy:', err.message);
        alert(`Deployment failed: ${err.message}`);
    } finally {
        btn.disabled = false;
        btn.textContent = 'Apply Deploy';
    }
}

document.getElementById('apply-deploy-btn').onclick = () => {
    const modal = document.getElementById('chat-modal');
    const jobId = modal.dataset.jobId || document.getElementById('chat-job-id').textContent;
    if (!jobId) {
        alert('Job ID is missing');
        return;
    }
    applyDeploy(jobId);
};

document.getElementById('close-chat').onclick = async () => {
    try {
        document.getElementById('chat-modal').style.display = 'none';
        await fetchJobs();
    } catch (err) {
        console.error('Error in close-chat:', err.message);
        alert(`Failed to close chat: ${err.message}`);
    }
};

document.getElementById('generate-btn').onclick = async () => {
    const generateBtn = document.getElementById('generate-btn');
    try {
        const description = document.getElementById('description').value.trim();
        const target = document.getElementById('target').value;

        if (!description || !target) {
            alert('Please provide both description and target');
            return;
        }
        if (!['terraform', 'kubernetes', 'ansible'].includes(target)) {
            alert('Invalid target selected');
            return;
        }

        generateBtn.disabled = true;
        generateBtn.textContent = 'Creating...';

        const response = await fetch(`${API_BASE}/jobs`, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({ description, target })
        });

        if (!response.ok) throw new Error(`Failed to create job: ${response.status}`);

        document.getElementById('description').value = '';
        document.getElementById('target').value = '';
        generateBtn.disabled = false;
        generateBtn.textContent = 'Create Job';

        await fetchJobs();
        alert('Job created successfully');
    } catch (err) {
        console.error('Error in create job:', err.message);
        alert(`Failed to create job: ${err.message}`);
    } finally {
        generateBtn.disabled = false;
        generateBtn.textContent = 'Create Job';
    }
};

try {
    fetchJobs();
    setInterval(fetchJobs, 5000);
} catch (err) {
    console.error('Error in initial setup:', err.message);
    alert(`Failed to initialize: ${err.message}`);
}
</script>
</body>
</html>
