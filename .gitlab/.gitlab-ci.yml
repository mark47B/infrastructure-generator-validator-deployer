stages:
  - build
  - test
  - docker
  - terraform

build:
  stage: build
  image: golang:1.24.6
  script:
    - cd orcestrator
    - go build -o myapp ./...
  artifacts:
    paths:
      - myapp
  only:
    - main

test:
  stage: test
  image: golang:1.24.6
  script:
    - cd orcestrator
    - go test ./... -v
  only:
    - main

docker:
  stage: docker
  image: docker:20.10
  services:
    - docker:dind
  variables:
    DOCKER_TLS_CERTDIR: ""
  script:
    - cd orcestrator
    - docker build -t orchestrator:$CI_COMMIT_SHA .
    - echo "Docker image built"
  only:
    - main

# -------------------------
# Terraform validation
# -------------------------
terraform-validate:
  stage: terraform
  image:
    name: hashicorp/terraform:1.9.8
    entrypoint: [""]
  variables:
    TF_IN_AUTOMATION: "1"
  before_script:
    - apk add --no-cache curl
    - curl -L https://github.com/terraform-linters/tflint/releases/download/v0.50.0/tflint_linux_amd64.zip -o tflint.zip
    - unzip tflint.zip && mv tflint /usr/local/bin/
    - terraform --version # Показываем версию Terraform
    - cd deployments
    - ls -la # Показываем содержимое директории deployments
  script:
    - |
      EXIT_CODE=0
      for dir in */; do
        if [ -f "$dir/main.tf" ]; then
          echo "Validating Terraform code in $dir"
          cd "$dir" || { echo "Failed to cd into $dir"; EXIT_CODE=1; continue; }
          
          echo "Contents of main.tf:"
          cat main.tf || echo "No main.tf found"
          
          echo "Running tflint in $dir"
          tflint --config=.tflint.hcl 2>&1 || { echo "tflint failed in $dir"; EXIT_CODE=1; }
          
          echo "Running terraform fmt in $dir"
          terraform fmt -check -recursive -diff 2>&1 || { echo "terraform fmt failed in $dir"; EXIT_CODE=1; }
          
          echo "Running terraform init in $dir"
          terraform init -backend=false 2>&1 || { echo "terraform init failed in $dir"; EXIT_CODE=1; }
          
          echo "Running terraform validate in $dir"
          terraform validate 2>&1 || { echo "terraform validate failed in $dir"; EXIT_CODE=1; }
          
          cd .. || { echo "Failed to return to deployments directory"; EXIT_CODE=1; }
        else
          echo "Skipping $dir: No main.tf found"
        fi
      done
      echo "Validation complete. Exit code: $EXIT_CODE"
      exit $EXIT_CODE
  rules:
    - if: $CI_PIPELINE_SOURCE != "schedule"